# LoopDetectionService 工作流程图

```mermaid
graph TD
    A[AI响应流事件] --> B{事件类型}

    B -->|ToolCallRequest| C[工具调用循环检测]
    B -->|Content| D[内容流循环检测]
    B -->|其他| E[忽略]

    C --> C1[计算工具调用哈希]
    C1 --> C2{与上次调用相同?}
    C2 -->|是| C3[重复计数+1]
    C2 -->|否| C4[重置计数为1]
    C3 --> C5{计数≥5?}
    C4 --> C5
    C5 -->|是| F1[检测到工具调用循环]
    C5 -->|否| G[继续监控]

    D --> D1{内容类型检测}
    D1 -->|代码块/表格/列表等| D2[重置内容追踪]
    D1 -->|普通文本| D3[添加到流历史]
    D2 --> G
    D3 --> D4[滑动窗口分析]
    D4 --> D5[提取50字符块]
    D5 --> D6[计算块哈希]
    D6 --> D7{哈希已存在?}
    D7 -->|否| D8[记录新块位置]
    D7 -->|是| D9[验证实际内容]
    D8 --> G
    D9 --> D10{内容完全匹配?}
    D10 -->|否| G
    D10 -->|是| D11[记录重复位置]
    D11 --> D12{重复次数≥10?}
    D12 -->|否| G
    D12 -->|是| D13[计算平均间距]
    D13 --> D14{平均间距≤250字符?}
    D14 -->|是| F2[检测到内容循环]
    D14 -->|否| G

    H[turnStarted事件] --> H1[轮数+1]
    H1 --> H2{轮数≥30 && 间隔≥检查间隔?}
    H2 -->|否| G
    H2 -->|是| H3[触发LLM检测]
    H3 --> H4[获取最近20轮历史]
    H4 --> H5[清理不完整函数调用]
    H5 --> H6[构造分析提示]
    H6 --> H7[调用循环检测LLM]
    H7 --> H8[解析结构化响应]
    H8 --> H9{置信度>0.9?}
    H9 -->|是| F3[检测到语义循环]
    H9 -->|否| H10[动态调整检查间隔]
    H10 --> G

    F1 --> I[记录循环事件]
    F2 --> I
    F3 --> I
    I --> J[返回true - 循环检测]

    G --> K[返回false - 继续执行]

    L[会话级禁用] --> M[所有检测跳过]

    style F1 fill:#ffcccc
    style F2 fill:#ffcccc
    style F3 fill:#ffcccc
    style I fill:#ff9999
    style J fill:#ff6666
```

## 三层检测机制对比

| 检测层次       | 检测目标         | 阈值         | 优点                   | 局限性             |
| -------------- | ---------------- | ------------ | ---------------------- | ------------------ |
| **工具调用层** | 连续相同工具调用 | 5次          | 响应快速、准确         | 只能检测简单重复   |
| **内容流层**   | 文本内容重复模式 | 10次/250字符 | 检测文本循环、内存可控 | 可能误报结构化内容 |
| **语义理解层** | 对话语义循环     | 置信度>0.9   | 理解上下文、智能判断   | 延迟高、资源消耗大 |

## 关键算法细节

### 滑动窗口算法

```
文本: "ABCDEFGHIJKLMNOP..."
窗口大小: 50字符
窗口1: "ABCDEFG...XYZ"  → 哈希A
窗口2:  "BCDEFGH...YZ0" → 哈希B
窗口3:   "CDEFGHI...Z01" → 哈希C
...
```

### 动态间隔调整

```
置信度 → 检查间隔
0.1   → 14轮 (低风险，少检查)
0.5   → 10轮 (中等风险)
0.9   → 6轮  (高风险，频繁检查)
```
