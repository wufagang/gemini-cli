@startuml Gemini CLI ç³»ç»Ÿæ¶æ„å›¾ - æ”¹è¿›ç‰ˆ
!theme aws-orange
!define DARKBLUE #1E3A8A
!define BLUE #3B82F6
!define LIGHTBLUE #DBEAFE
!define GREEN #10B981
!define LIGHTGREEN #D1FAE5
!define ORANGE #F59E0B
!define LIGHTORANGE #FEF3C7
!define PURPLE #8B5CF6
!define LIGHTPURPLE #EDE9FE
!define RED #EF4444
!define LIGHTRED #FEE2E2

title **Gemini CLI ç³»ç»Ÿæ¶æ„å›¾**\nåˆ†å±‚æ¶æ„ + æ¨¡å—åŒ–è®¾è®¡ + å®‰å…¨æ²™ç®±

!procedure $layer($name, $color, $description)
  rectangle "$name" $color {
    note top : $description
  }
!endprocedure

' ========================================
' ç¬¬ä¸€å±‚ï¼šç”¨æˆ·äº¤äº’å±‚ (Presentation Layer)
' ========================================
package "ğŸ–¥ï¸ **ç”¨æˆ·äº¤äº’å±‚ (CLI Package)**" as presentation_layer LIGHTBLUE {

  note top of presentation_layer
    **æ ¸å¿ƒèŒè´£ï¼š**
    â€¢ å¤„ç†ç”¨æˆ·è¾“å…¥å’Œå‘½ä»¤è§£æ
    â€¢ æä¾›ç°ä»£åŒ–ç»ˆç«¯UIä½“éªŒ
    â€¢ ç®¡ç†ä¸»é¢˜ã€å¿«æ·é”®ã€Vimæ¨¡å¼
    â€¢ æ ¼å¼åŒ–è¾“å‡ºå’Œæµå¼å†…å®¹æ¸²æŸ“
  end note

  package "React + Ink ç»ˆç«¯UIæ¡†æ¶" as ui_framework BLUE {
    [AppContainer\nåº”ç”¨å®¹å™¨] as app_container
    [ChatInterface\nå¯¹è¯ç•Œé¢] as chat_interface
    [StreamingContent\næµå¼å†…å®¹æ¸²æŸ“] as streaming_content
    [ThemeProvider\nä¸»é¢˜ç®¡ç†] as theme_provider
    [VimModeProvider\nVimæ¨¡å¼æ”¯æŒ] as vim_provider

    note bottom of ui_framework
      **æŠ€æœ¯ç‰¹æ€§ï¼š**
      â€¢ å£°æ˜å¼UIç»„ä»¶
      â€¢ å®æ—¶å“åº”æ¸²æŸ“
      â€¢ æ— éšœç¢æ”¯æŒ
      â€¢ é”®ç›˜å¿«æ·é”®
    end note
  }

  package "å‘½ä»¤å¤„ç†æ¨¡å—" as command_processing BLUE {
    [CommandParser\nå‘½ä»¤è§£æå™¨] as cmd_parser
    [ArgumentValidator\nå‚æ•°éªŒè¯] as arg_validator
    [OutputFormatter\nè¾“å‡ºæ ¼å¼åŒ–] as output_formatter

    note bottom of command_processing
      **å¤„ç†æµç¨‹ï¼š**
      è¾“å…¥ â†’ è§£æ â†’ éªŒè¯ â†’ æ‰§è¡Œ â†’ æ ¼å¼åŒ–
    end note
  }
}

' ========================================
' ç¬¬äºŒå±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)
' ========================================
package "ğŸ¯ **ä¸šåŠ¡é€»è¾‘å±‚ (Core Package)**" as business_layer LIGHTPURPLE {

  note top of business_layer
    **æ ¸å¿ƒèŒè´£ï¼š**
    â€¢ Gemini AIå®¢æˆ·ç«¯å’Œå¯¹è¯ç®¡ç†
    â€¢ å·¥å…·ç³»ç»Ÿæ³¨å†Œå’Œæ‰§è¡Œåè°ƒ
    â€¢ å¤šå±‚é…ç½®ç³»ç»Ÿå’Œç­–ç•¥å¼•æ“
    â€¢ è®¤è¯ç®¡ç†å’Œå®‰å…¨æ§åˆ¶
  end note

  package "AI å®¢æˆ·ç«¯æ ¸å¿ƒ" as ai_core PURPLE {
    [GeminiClient\nAIå®¢æˆ·ç«¯] as gemini_client
    [ChatCompressionService\nå¯¹è¯å‹ç¼©] as chat_compression
    [LoopDetectionService\nå¾ªç¯æ£€æµ‹] as loop_detection
    [ModelRouterService\næ¨¡å‹è·¯ç”±] as model_router

    note bottom of ai_core
      **æ ¸å¿ƒèƒ½åŠ›ï¼š**
      â€¢ æµå¼AIå¯¹è¯
      â€¢ æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†
      â€¢ è‡ªåŠ¨æ¨¡å‹é€‰æ‹©
      â€¢ é˜²æ­»å¾ªç¯æœºåˆ¶
    end note
  }

  package "å·¥å…·æ³¨å†Œä¸­å¿ƒ" as tool_registry PURPLE {
    [ToolRegistry\nå·¥å…·æ³¨å†Œè¡¨] as tool_registry_comp
    [McpClientManager\nMCPå®¢æˆ·ç«¯ç®¡ç†] as mcp_manager
    [ToolDiscovery\nå·¥å…·å‘ç°] as tool_discovery
    [ToolValidator\nå·¥å…·éªŒè¯] as tool_validator

    note bottom of tool_registry
      **ç®¡ç†åŠŸèƒ½ï¼š**
      â€¢ å†…ç½®å·¥å…·æ³¨å†Œ
      â€¢ MCPåè®®é›†æˆ
      â€¢ åŠ¨æ€å·¥å…·å‘ç°
      â€¢ å·¥å…·æƒé™éªŒè¯
    end note
  }

  package "é…ç½®å’Œå®‰å…¨ç®¡ç†" as config_security PURPLE {
    [ConfigManager\né…ç½®ç®¡ç†å™¨] as config_manager
    [PolicyEngine\nç­–ç•¥å¼•æ“] as policy_engine
    [AuthProvider\nè®¤è¯æä¾›è€…] as auth_provider
    [SandboxManager\næ²™ç®±ç®¡ç†å™¨] as sandbox_manager

    note bottom of config_security
      **å®‰å…¨ç‰¹æ€§ï¼š**
      â€¢ å¤šå±‚é…ç½®è¦†ç›–
      â€¢ ä¼ä¸šç­–ç•¥æ§åˆ¶
      â€¢ å¤šç§è®¤è¯æ–¹å¼
      â€¢ æ²™ç®±å®‰å…¨æ‰§è¡Œ
    end note
  }
}

' ========================================
' ç¬¬ä¸‰å±‚ï¼šå·¥å…·æ‰§è¡Œå±‚ (Tool Execution Layer)
' ========================================
package "ğŸ”§ **å·¥å…·æ‰§è¡Œå±‚ (Tools Layer)**" as execution_layer LIGHTGREEN {

  note top of execution_layer
    **æ ¸å¿ƒèŒè´£ï¼š**
    â€¢ æä¾›20+å†…ç½®å·¥å…·é›†åˆ
    â€¢ æ”¯æŒMCPåè®®ç¬¬ä¸‰æ–¹å·¥å…·
    â€¢ åœ¨æ²™ç®±ç¯å¢ƒä¸­å®‰å…¨æ‰§è¡Œ
    â€¢ å¤„ç†æ–‡ä»¶ã€ç½‘ç»œã€ç³»ç»Ÿæ“ä½œ
  end note

  package "å†…ç½®å·¥å…·é›† (Built-in Tools)" as builtin_tools GREEN {
    [ReadFileTool\næ–‡ä»¶è¯»å–] as read_tool
    [WriteFileTool\næ–‡ä»¶å†™å…¥] as write_tool
    [EditTool\næ–‡ä»¶ç¼–è¾‘] as edit_tool
    [ShellTool\nShellæ‰§è¡Œ] as shell_tool
    [GrepTool\nä»£ç æœç´¢] as grep_tool
    [WebFetchTool\nç½‘ç»œè¯·æ±‚] as web_fetch_tool

    note bottom of builtin_tools
      **å·¥å…·åˆ†ç±»ï¼š**
      â€¢ æ–‡ä»¶æ“ä½œï¼šè¯»å–ã€å†™å…¥ã€ç¼–è¾‘
      â€¢ ç³»ç»Ÿäº¤äº’ï¼šShellã€ç›®å½•åˆ—è¡¨
      â€¢ æœç´¢å¯¼èˆªï¼šGrepã€GlobåŒ¹é…
      â€¢ ç½‘ç»œé€šä¿¡ï¼šHTTPè¯·æ±‚ã€æœç´¢
    end note
  }

  package "æ‰©å±•å·¥å…·é›† (Extension Tools)" as extension_tools GREEN {
    [MCPProxyTool\nMCPä»£ç†å·¥å…·] as mcp_proxy
    [CustomToolLoader\nè‡ªå®šä¹‰å·¥å…·åŠ è½½å™¨] as custom_loader
    [ThirdPartyTools\nç¬¬ä¸‰æ–¹å·¥å…·] as third_party_tools

    note bottom of extension_tools
      **æ‰©å±•æœºåˆ¶ï¼š**
      â€¢ MCPåè®®æ ‡å‡†åŒ–
      â€¢ åŠ¨æ€å·¥å…·åŠ è½½
      â€¢ ç¤¾åŒºç”Ÿæ€æ”¯æŒ
    end note
  }
}

' ========================================
' ç¬¬å››å±‚ï¼šåŸºç¡€æœåŠ¡å±‚ (Infrastructure Layer)
' ========================================
package "âš™ï¸ **åŸºç¡€æœåŠ¡å±‚ (Services Layer)**" as infrastructure_layer LIGHTORANGE {

  note top of infrastructure_layer
    **æ ¸å¿ƒèŒè´£ï¼š**
    â€¢ æä¾›è·¨æ¨¡å—çš„åŸºç¡€æœåŠ¡
    â€¢ å¤„ç†æ–‡ä»¶ç³»ç»Ÿå’ŒGité›†æˆ
    â€¢ ç®¡ç†Shellæ‰§è¡Œå’Œæ²™ç®±ç¯å¢ƒ
    â€¢ æ”¯æŒé¥æµ‹ã€æ—¥å¿—å’Œäº‹ä»¶é€šä¿¡
  end note

  package "æ ¸å¿ƒæœåŠ¡é›†ç¾¤" as core_services ORANGE {
    [FileDiscoveryService\næ–‡ä»¶å‘ç°æœåŠ¡] as file_discovery
    [GitService\nGité›†æˆæœåŠ¡] as git_service
    [ShellExecutionService\nShellæ‰§è¡ŒæœåŠ¡] as shell_execution
    [TelemetryService\né¥æµ‹æœåŠ¡] as telemetry
    [MessageBus\näº‹ä»¶æ€»çº¿] as message_bus

    note bottom of core_services
      **æœåŠ¡èƒ½åŠ›ï¼š**
      â€¢ æ™ºèƒ½æ–‡ä»¶å‘ç°å’Œè¿‡æ»¤
      â€¢ Gitç‰ˆæœ¬æ§åˆ¶é›†æˆ
      â€¢ å®‰å…¨Shellå‘½ä»¤æ‰§è¡Œ
      â€¢ ä½¿ç”¨æ•°æ®æ”¶é›†åˆ†æ
      â€¢ ç»„ä»¶é—´äº‹ä»¶é€šä¿¡
    end note
  }

  package "ä¸“ç”¨æœåŠ¡" as specialized_services ORANGE {
    [ChatRecordingService\nå¯¹è¯è®°å½•] as chat_recording
    [TrustService\nä¿¡ä»»ç®¡ç†] as trust_service
    [CredentialStorage\nå‡­æ®å­˜å‚¨] as credential_storage

    note bottom of specialized_services
      **ä¸“ä¸šåŠŸèƒ½ï¼š**
      â€¢ å¯¹è¯å†å²ç®¡ç†
      â€¢ å·¥ä½œåŒºä¿¡ä»»æ§åˆ¶
      â€¢ å®‰å…¨å‡­æ®å­˜å‚¨
    end note
  }
}

' ========================================
' ç¬¬äº”å±‚ï¼šå¤–éƒ¨é›†æˆå±‚ (External Integration Layer)
' ========================================
package "ğŸŒ **å¤–éƒ¨é›†æˆå±‚ (External Systems)**" as external_layer LIGHTRED {

  note top of external_layer
    **æ ¸å¿ƒèŒè´£ï¼š**
    â€¢ é›†æˆGoogle AIå’ŒCloudæœåŠ¡
    â€¢ è¿æ¥MCPç”Ÿæ€ç³»ç»Ÿ
    â€¢ æ”¯æŒå¤šç§å®¹å™¨è¿è¡Œæ—¶
    â€¢ æ•´åˆå¼€å‘å·¥å…·å’ŒIDE
  end note

  package "Google æœåŠ¡ç”Ÿæ€" as google_ecosystem RED {
    [Gemini API\nAIæœåŠ¡] as gemini_api
    [Google Search API\næœç´¢æœåŠ¡] as search_api
    [Google OAuth\nè®¤è¯æœåŠ¡] as oauth_service
    [Vertex AI\nä¼ä¸šAIå¹³å°] as vertex_ai
    [Google Cloud Storage\näº‘å­˜å‚¨] as gcs

    note bottom of google_ecosystem
      **æœåŠ¡é›†æˆï¼š**
      â€¢ Gemini 2.5 Pro AIæ¨¡å‹
      â€¢ å®æ—¶æœç´¢grounding
      â€¢ ä¼ä¸šçº§OAuthè®¤è¯
      â€¢ Vertex AIä¼ä¸šéƒ¨ç½²
    end note
  }

  package "å¼€å‘è€…ç”Ÿæ€" as developer_ecosystem RED {
    [VS Code\nä»£ç ç¼–è¾‘å™¨] as vscode
    [Docker/Podman\nå®¹å™¨è¿è¡Œæ—¶] as containers
    [MCP Servers\nç¬¬ä¸‰æ–¹å·¥å…·æœåŠ¡] as mcp_servers
    [File System\næ–‡ä»¶ç³»ç»Ÿ] as filesystem

    note bottom of developer_ecosystem
      **å¼€å‘é›†æˆï¼š**
      â€¢ IDEä¸Šä¸‹æ–‡åŒæ­¥
      â€¢ å®¹å™¨åŒ–æ²™ç®±æ‰§è¡Œ
      â€¢ MCPåè®®å·¥å…·æ‰©å±•
      â€¢ æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè®¿é—®
    end note
  }
}

' ========================================
' æ•°æ®å­˜å‚¨å±‚ (Data Layer)
' ========================================
database "ğŸ’¾ **æ•°æ®å­˜å‚¨å±‚**" as data_layer {
  [é…ç½®æ–‡ä»¶\n~/.gemini/settings.json] as config_files
  [ç¼“å­˜å­˜å‚¨\nä¸´æ—¶æ•°æ®å’ŒAPIå“åº”] as cache_storage
  [å‡­æ®å­˜å‚¨\nåŠ å¯†çš„è®¤è¯ä¿¡æ¯] as creds_storage
  [å¯¹è¯å†å²\nä¼šè¯è®°å½•å’Œæ£€æŸ¥ç‚¹] as chat_history
  [æ‰©å±•å­˜å‚¨\nç¬¬ä¸‰æ–¹å·¥å…·å’Œä¸»é¢˜] as extension_storage

  note bottom of data_layer
    **å­˜å‚¨ç­–ç•¥ï¼š**
    â€¢ åˆ†å±‚é…ç½®æ–‡ä»¶ç®¡ç†
    â€¢ æ™ºèƒ½ç¼“å­˜å’Œè¿‡æœŸæœºåˆ¶
    â€¢ å®‰å…¨å‡­æ®åŠ å¯†å­˜å‚¨
    â€¢ å¯¹è¯å†å²æŒä¹…åŒ–
    â€¢ æ‰©å±•ç”Ÿå‘½å‘¨æœŸç®¡ç†
  end note
}

' ========================================
' æ ¸å¿ƒæ•°æ®æµè¿æ¥ (ä»ä¸Šåˆ°ä¸‹)
' ========================================

' ç”¨æˆ·äº¤äº’å±‚ â†’ ä¸šåŠ¡é€»è¾‘å±‚
presentation_layer -down-> business_layer : **ç”¨æˆ·è¯·æ±‚å¤„ç†**
app_container -down-> gemini_client : "å‘é€ç”¨æˆ·è¾“å…¥"
chat_interface -down-> tool_registry_comp : "è·å–å¯ç”¨å·¥å…·"
streaming_content -down-> gemini_client : "æ¥æ”¶AIå“åº”æµ"

' ä¸šåŠ¡é€»è¾‘å±‚ â†’ å·¥å…·æ‰§è¡Œå±‚
business_layer -down-> execution_layer : **å·¥å…·è°ƒç”¨æ‰§è¡Œ**
tool_registry_comp -down-> builtin_tools : "å†…ç½®å·¥å…·æ³¨å†Œ"
mcp_manager -down-> extension_tools : "MCPå·¥å…·é›†æˆ"
sandbox_manager -down-> builtin_tools : "æ²™ç®±å®‰å…¨æ‰§è¡Œ"

' å·¥å…·æ‰§è¡Œå±‚ â†’ åŸºç¡€æœåŠ¡å±‚
execution_layer -down-> infrastructure_layer : **åŸºç¡€æœåŠ¡è°ƒç”¨**
shell_tool -down-> shell_execution : "Shellå‘½ä»¤æ‰§è¡Œ"
edit_tool -down-> git_service : "Gitæ“ä½œé›†æˆ"
builtin_tools -down-> file_discovery : "æ–‡ä»¶ç³»ç»Ÿæ“ä½œ"

' åŸºç¡€æœåŠ¡å±‚ â†’ å¤–éƒ¨é›†æˆå±‚
infrastructure_layer -down-> external_layer : **å¤–éƒ¨ç³»ç»Ÿé›†æˆ**
shell_execution -down-> containers : "å®¹å™¨æ²™ç®±æ‰§è¡Œ"
core_services -down-> filesystem : "æ–‡ä»¶ç³»ç»Ÿè®¿é—®"

' ä¸šåŠ¡é€»è¾‘å±‚ â†’ å¤–éƒ¨é›†æˆå±‚ (ç›´æ¥è¿æ¥)
gemini_client -right-> gemini_api : "**AI APIè°ƒç”¨**"
auth_provider -right-> oauth_service : "OAuthè®¤è¯"
mcp_manager -right-> mcp_servers : "MCPåè®®é€šä¿¡"

' æ•°æ®å­˜å‚¨è¿æ¥
business_layer -down-> data_layer : **æ•°æ®æŒä¹…åŒ–**
config_manager -down-> config_files : "é…ç½®ç®¡ç†"
auth_provider -down-> creds_storage : "å‡­æ®å­˜å‚¨"
chat_compression -down-> chat_history : "å¯¹è¯è®°å½•"

' ========================================
' å…³é”®æ¶æ„ç‰¹æ€§æ ‡æ³¨
' ========================================

note top of presentation_layer
  **ğŸ¨ ç°ä»£ç»ˆç«¯UI**
  React + Ink æ¡†æ¶
  å£°æ˜å¼ç»„ä»¶å¼€å‘
end note

note top of business_layer
  **ğŸ§  AIæ ¸å¿ƒå¤§è„‘**
  Geminiå®¢æˆ·ç«¯
  å·¥å…·ç¼–æ’å¼•æ“
end note

note top of execution_layer
  **ğŸ› ï¸ ä¸°å¯Œå·¥å…·ç”Ÿæ€**
  20+ å†…ç½®å·¥å…·
  MCPæ‰©å±•æ”¯æŒ
end note

note top of infrastructure_layer
  **âš¡ é«˜æ€§èƒ½æœåŠ¡**
  å¼‚æ­¥å¤„ç†
  äº‹ä»¶é©±åŠ¨æ¶æ„
end note

note top of external_layer
  **ğŸ”— å¼€æ”¾é›†æˆ**
  Googleç”Ÿæ€
  å¼€å‘è€…å·¥å…·
end note

' ========================================
' å®‰å…¨å’Œæ€§èƒ½æ ‡æ³¨
' ========================================

note left of sandbox_manager
  **ğŸ”’ å¤šå±‚å®‰å…¨é˜²æŠ¤**
  â€¢ Docker/Podman å®¹å™¨éš”ç¦»
  â€¢ macOS Seatbelt æ²™ç®±
  â€¢ å·¥ä½œåŒºä¿¡ä»»æœºåˆ¶
  â€¢ ç”¨æˆ·ç¡®è®¤æµç¨‹
  â€¢ å‘½ä»¤æ³¨å…¥é˜²æŠ¤
end note

note right of gemini_client
  **âš¡ æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§**
  â€¢ æµå¼å“åº”å¤„ç†
  â€¢ æ™ºèƒ½ä¸Šä¸‹æ–‡å‹ç¼©
  â€¢ è‡ªé€‚åº”å†…å­˜ç®¡ç†
  â€¢ å¤šçº§ç¼“å­˜ç­–ç•¥
  â€¢ å¼‚æ­¥å¹¶å‘æ‰§è¡Œ
end note

@enduml