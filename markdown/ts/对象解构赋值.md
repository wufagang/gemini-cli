# JavaScript/TypeScript å¯¹è±¡è§£æ„èµ‹å€¼è¯¦è§£

## æ¦‚è¿°

å¯¹è±¡è§£æ„èµ‹å€¼æ˜¯ JavaScript/TypeScript ä¸­ä¸€ä¸ªå¼ºå¤§çš„è¯­æ³•ç‰¹æ€§ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä»å¯¹è±¡ä¸­æå–å±æ€§å¹¶èµ‹å€¼ç»™å˜é‡ï¼Œä½¿ä»£ç æ›´åŠ ç®€æ´å’Œå¯è¯»ã€‚åœ¨ Gemini
CLI çš„ Agent ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªè¯­æ³•è¢«å¹¿æ³›ä½¿ç”¨æ¥ä¼˜åŒ–ä»£ç ç»“æ„ã€‚

## åŸºæœ¬è¯­æ³•

### 1. ä¼ ç»Ÿæ–¹å¼ vs è§£æ„èµ‹å€¼

```typescript
// ä¼ ç»Ÿæ–¹å¼
const result = someFunction();
const name = result.name;
const age = result.age;

// è§£æ„èµ‹å€¼
const { name, age } = someFunction();
```

### 2. Gemini CLI ä¸­çš„å®é™…ä¾‹å­

```typescript
// packages/core/src/agents/executor.ts:193-195
const { functionCalls } = await promptIdContext.run(promptId, async () =>
  this.callModel(chat, currentMessage, tools, combinedSignal, promptId),
);
```

## ä¸ºä»€ä¹ˆä½¿ç”¨ `{ functionCalls }`ï¼Ÿ

### 1. callModel æ–¹æ³•çš„è¿”å›å€¼ç»“æ„

```typescript
// callModel æ–¹æ³•çš„è¿”å›ç±»å‹
private async callModel(
  chat: GeminiChat,
  message: Content,
  tools: FunctionDeclaration[],
  signal: AbortSignal,
  promptId: string,
): Promise<{ functionCalls: FunctionCall[]; textResponse: string }> {

  const functionCalls: FunctionCall[] = [];
  let textResponse = '';

  // å¤„ç†æ¨¡å‹å“åº”æµ
  for await (const resp of responseStream) {
    if (signal.aborted) break;

    if (resp.type === StreamEventType.CHUNK) {
      const chunk = resp.value;

      // æ”¶é›†å‡½æ•°è°ƒç”¨
      if (chunk.functionCalls) {
        functionCalls.push(...chunk.functionCalls);
      }

      // æ”¶é›†æ–‡æœ¬å“åº”
      const text = parts
        ?.filter((p) => !p.thought && p.text)
        .map((p) => p.text)
        .join('') || '';

      if (text) {
        textResponse += text;
      }
    }
  }

  // è¿”å›åŒ…å«ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡
  return { functionCalls, textResponse };
}
```

### 2. åªéœ€è¦éƒ¨åˆ†æ•°æ®

åœ¨ `executeTurn` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åªå…³å¿ƒ `functionCalls`ï¼Œä¸éœ€è¦ `textResponse`ï¼š

```typescript
private async executeTurn(/*...*/): Promise<AgentTurnResult> {
  // åªæå–éœ€è¦çš„ functionCalls
  const { functionCalls } = await promptIdContext.run(promptId, async () =>
    this.callModel(chat, currentMessage, tools, combinedSignal, promptId),
  );

  // æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
  if (functionCalls.length === 0) {
    this.emitActivity('ERROR', {
      error: `Agent stopped calling tools but did not call 'complete_task'`,
      context: 'protocol_violation',
    });
    return {
      status: 'stop',
      terminateReason: AgentTerminateMode.ERROR_NO_COMPLETE_TASK_CALL,
      finalResult: null,
    };
  }

  // å¤„ç†å·¥å…·è°ƒç”¨
  const { nextMessage, submittedOutput, taskCompleted } =
    await this.processFunctionCalls(functionCalls, combinedSignal, promptId);

  // textResponse åœ¨è¿™é‡Œä¸éœ€è¦ï¼Œå› ä¸ºæ–‡æœ¬å“åº”å·²ç»é€šè¿‡äº‹ä»¶æµå‘é€ç»™ç”¨æˆ·äº†
}
```

## è§£æ„èµ‹å€¼çš„å„ç§å½¢å¼

### 1. åŸºæœ¬è§£æ„

```typescript
const person = { name: 'Alice', age: 30, city: 'Beijing' };

// æå–å¤šä¸ªå±æ€§
const { name, age } = person;
console.log(name); // 'Alice'
console.log(age); // 30
```

### 2. é‡å‘½åå˜é‡

```typescript
const { name: userName, age: userAge } = person;
console.log(userName); // 'Alice'
console.log(userAge); // 30
```

### 3. é»˜è®¤å€¼

```typescript
const { name = 'Anonymous', email = 'no-email' } = person;
console.log(name); // 'Alice' (å­˜åœ¨)
console.log(email); // 'no-email' (ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼)
```

### 4. åµŒå¥—è§£æ„

```typescript
const user = {
  profile: {
    personal: {
      name: 'Alice',
      age: 30,
    },
    contact: {
      email: 'alice@example.com',
    },
  },
};

// åµŒå¥—è§£æ„
const {
  profile: {
    personal: { name },
    contact: { email },
  },
} = user;

console.log(name); // 'Alice'
console.log(email); // 'alice@example.com'
```

### 5. å‰©ä½™å±æ€§ (Rest Properties)

```typescript
const { name, ...otherProps } = person;
console.log(name); // 'Alice'
console.log(otherProps); // { age: 30, city: 'Beijing' }
```

## åœ¨ Gemini CLI ä¸­çš„å®é™…åº”ç”¨

### 1. Agent é…ç½®è§£æ„

```typescript
// ä» AgentDefinition ä¸­æå–é…ç½®
const { promptConfig, modelConfig, runConfig } = this.definition;

// ä»æ¨¡å‹é…ç½®ä¸­æå–å‚æ•°
const { model, temp, top_p, thinkingBudget } = modelConfig;

// ä½¿ç”¨æå–çš„é…ç½®
const generationConfig: GenerateContentConfig = {
  temperature: temp,
  topP: top_p,
  thinkingConfig: {
    includeThoughts: true,
    thinkingBudget: thinkingBudget ?? -1,
  },
};
```

### 2. å·¥å…·æ‰§è¡Œç»“æœè§£æ„

```typescript
// ä»å·¥å…·æ‰§è¡Œç»“æœä¸­æå–å“åº”
const { response: toolResponse } = await executeToolCall(
  this.runtimeContext,
  requestInfo,
  signal,
);

// æ£€æŸ¥å·¥å…·æ‰§è¡Œæ˜¯å¦æˆåŠŸ
if (toolResponse.error) {
  this.emitActivity('ERROR', {
    context: 'tool_call',
    name: functionCall.name,
    error: toolResponse.error.message,
  });
} else {
  this.emitActivity('TOOL_CALL_END', {
    name: functionCall.name,
    output: toolResponse.resultDisplay,
  });
}
```

### 3. Agent è¾“å‡ºè§£æ„

```typescript
// ä» Agent æ‰§è¡Œç»“æœä¸­æå–æ•°æ®
const output = await executor.run(this.params, signal);

// åœ¨ SubagentInvocation ä¸­ä½¿ç”¨
const { result, terminate_reason } = output;

const resultContent = `Subagent '${this.definition.name}' finished.
Termination Reason: ${terminate_reason}
Result:
${result}`;
```

### 4. å‡½æ•°å‚æ•°è§£æ„

```typescript
// ç›´æ¥åœ¨å‡½æ•°å‚æ•°ä¸­è§£æ„
function processAgentResult({ result, terminate_reason }: OutputObject) {
  console.log(`Task completed with reason: ${terminate_reason}`);
  console.log(`Result: ${result}`);
}

// åœ¨æ–¹æ³•ä¸­è§£æ„é…ç½®å¯¹è±¡
private buildSystemPrompt({ systemPrompt, query }: PromptConfig, inputs: AgentInputs): string {
  let finalPrompt = templateString(systemPrompt || '', inputs);

  if (query) {
    finalPrompt += `\n\nTask: ${templateString(query, inputs)}`;
  }

  return finalPrompt;
}
```

## æ•°ç»„è§£æ„

### 1. åŸºæœ¬æ•°ç»„è§£æ„

```typescript
const colors = ['red', 'green', 'blue'];

// æ•°ç»„è§£æ„
const [first, second, third] = colors;
console.log(first); // 'red'
console.log(second); // 'green'
console.log(third); // 'blue'

// è·³è¿‡å…ƒç´ 
const [, , blue] = colors;
console.log(blue); // 'blue'

// å‰©ä½™å…ƒç´ 
const [primary, ...secondary] = colors;
console.log(primary); // 'red'
console.log(secondary); // ['green', 'blue']
```

### 2. åœ¨ Gemini CLI ä¸­çš„æ•°ç»„è§£æ„åº”ç”¨

```typescript
// è§£æ„å‡½æ•°è°ƒç”¨çš„å¤šä¸ªè¿”å›å€¼
const [toolName, ...args] = functionCall.name.split('.');

// è§£æ„æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
const [firstCandidate] = chunk.candidates || [];

// äº¤æ¢å˜é‡
[a, b] = [b, a];
```

## ç±»å‹å®‰å…¨ä¸è§£æ„

### 1. TypeScript ç±»å‹æ¨æ–­

```typescript
interface ModelResponse {
  functionCalls: FunctionCall[];
  textResponse: string;
  metadata?: ResponseMetadata;
}

// TypeScript è‡ªåŠ¨æ¨æ–­ç±»å‹
const { functionCalls, textResponse } = await callModel(/*...*/);
// functionCalls: FunctionCall[]
// textResponse: string

// åªæå–éœ€è¦çš„å±æ€§
const { functionCalls } = await callModel(/*...*/);
// functionCalls: FunctionCall[] (textResponse è¢«å¿½ç•¥)
```

### 2. æ˜¾å¼ç±»å‹æ³¨è§£

```typescript
// å½“éœ€è¦æ›´æ˜ç¡®çš„ç±»å‹æ§åˆ¶æ—¶
const { functionCalls }: { functionCalls: FunctionCall[] } =
  await callModel(/*...*/);

// æˆ–è€…ä½¿ç”¨æ¥å£
interface ExtractedResponse {
  functionCalls: FunctionCall[];
}

const { functionCalls }: ExtractedResponse = await callModel(/*...*/);
```

### 3. å¯é€‰å±æ€§è§£æ„

```typescript
interface AgentConfig {
  name: string;
  description: string;
  toolConfig?: ToolConfig;
  outputConfig?: OutputConfig;
}

// è§£æ„å¯é€‰å±æ€§
const { name, description, toolConfig = null, outputConfig } = agentConfig;

// ä½¿ç”¨é»˜è®¤å€¼å¤„ç†å¯é€‰å±æ€§
const { toolConfig = { tools: [] }, outputConfig = null } = this.definition;
```

## æ€§èƒ½è€ƒè™‘

### 1. è§£æ„ vs ç›´æ¥è®¿é—®

```typescript
// è§£æ„æ–¹å¼ - åˆ›å»ºæ–°å˜é‡
const { functionCalls, textResponse } = result;
console.log(functionCalls.length);

// ç›´æ¥è®¿é—® - ä¸åˆ›å»ºæ–°å˜é‡
console.log(result.functionCalls.length);

// æ€§èƒ½å·®å¼‚é€šå¸¸å¯ä»¥å¿½ç•¥ï¼Œä¼˜å…ˆè€ƒè™‘å¯è¯»æ€§
```

### 2. æ·±å±‚è§£æ„çš„æ€§èƒ½

```typescript
// æ·±å±‚è§£æ„å¯èƒ½å½±å“æ€§èƒ½
const {
  config: {
    model: {
      params: { temperature },
    },
  },
} = complexObject;

// è€ƒè™‘åˆ†æ­¥è§£æ„
const { config } = complexObject;
const { model } = config;
const { params } = model;
const { temperature } = params;
```

## æœ€ä½³å®è·µ

### 1. åªæå–éœ€è¦çš„å±æ€§

```typescript
// âœ… å¥½çš„åšæ³• - åªæå–éœ€è¦çš„
const { functionCalls } = await this.callModel(/*...*/);

// âŒ é¿å… - æå–ä¸éœ€è¦çš„å±æ€§
const { functionCalls, textResponse } = await this.callModel(/*...*/);
// å¦‚æœä¸ä½¿ç”¨ textResponseï¼Œä¼šé€ æˆæ··ä¹±
```

### 2. ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å

```typescript
// âœ… æ¸…æ™°çš„é‡å‘½å
const { name: agentName, config: agentConfig } = agentDefinition;

// âœ… æˆ–è€…ä¿æŒåŸåï¼ˆå¦‚æœæ¸…æ™°ï¼‰
const { name, config } = agentDefinition;

// âŒ é¿å…ä¸æ¸…æ™°çš„é‡å‘½å
const { name: n, config: c } = agentDefinition;
```

### 3. åˆç†ä½¿ç”¨é»˜è®¤å€¼

```typescript
// âœ… ä¸ºå¯èƒ½ä¸å­˜åœ¨çš„å±æ€§æä¾›é»˜è®¤å€¼
const { maxTurns = 10, timeout = 300000, tools = [] } = config;

// âœ… ä½¿ç”¨åˆç†çš„é»˜è®¤å€¼
const { temperature = 0.7, topP = 0.9 } = modelConfig;
```

### 4. é¿å…è¿‡åº¦åµŒå¥—

```typescript
// âŒ è¿‡åº¦åµŒå¥—ï¼Œéš¾ä»¥ç†è§£
const {
  agent: {
    config: {
      model: {
        params: { temp, topP },
      },
    },
  },
} = complexConfig;

// âœ… åˆ†æ­¥è§£æ„ï¼Œæ›´æ¸…æ™°
const { agent } = complexConfig;
const { config } = agent;
const { model } = config;
const { params } = model;
const { temp, topP } = params;
```

### 5. åœ¨å‡½æ•°å‚æ•°ä¸­ä½¿ç”¨è§£æ„

```typescript
// âœ… å‡½æ•°å‚æ•°è§£æ„ï¼Œæ¥å£æ¸…æ™°
function createAgent({ name, description, tools = [] }: AgentOptions) {
  // ç›´æ¥ä½¿ç”¨è§£æ„åçš„å‚æ•°
  return new Agent(name, description, tools);
}

// âœ… å¯é€‰å‚æ•°çš„è§£æ„
function executeAgent({
  signal,
  timeout = 60000,
  onProgress,
}: ExecutionOptions = {}) {
  // å¤„ç†æ‰§è¡Œé€»è¾‘
}
```

## é”™è¯¯å¤„ç†ä¸è§£æ„

### 1. å®‰å…¨è§£æ„

```typescript
// âœ… å®‰å…¨çš„è§£æ„ï¼Œå¤„ç† undefined/null
const response = await callModel(/*...*/);
if (response) {
  const { functionCalls = [] } = response;
  // å®‰å…¨ä½¿ç”¨ functionCalls
}

// âœ… ä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦
const { functionCalls } = response ?? {};

// âœ… æä¾›é»˜è®¤å€¼
const { functionCalls = [] } = response || {};
```

### 2. ç±»å‹å®ˆå«ä¸è§£æ„

```typescript
// ç±»å‹å®ˆå«å‡½æ•°
function isValidResponse(response: any): response is ModelResponse {
  return (
    response &&
    Array.isArray(response.functionCalls) &&
    typeof response.textResponse === 'string'
  );
}

// å®‰å…¨è§£æ„
const response = await callModel(/*...*/);
if (isValidResponse(response)) {
  const { functionCalls, textResponse } = response;
  // ç±»å‹å®‰å…¨çš„ä½¿ç”¨
}
```

## åœ¨å¼‚æ­¥æ“ä½œä¸­çš„è§£æ„

### 1. Promise ç»“æœè§£æ„

```typescript
// âœ… ç›´æ¥è§£æ„ Promise ç»“æœ
const { functionCalls } = await promptIdContext.run(promptId, async () =>
  this.callModel(chat, currentMessage, tools, combinedSignal, promptId),
);

// âœ… å¤šä¸ªå¼‚æ­¥æ“ä½œçš„è§£æ„
const [agentResult, toolResult] = await Promise.all([
  executeAgent(agentConfig),
  executeTool(toolConfig),
]);

const { output: agentOutput } = agentResult;
const { result: toolResult } = toolResult;
```

### 2. é”™è¯¯å¤„ç†ä¸è§£æ„

```typescript
try {
  const { functionCalls, textResponse } = await this.callModel(/*...*/);
  // å¤„ç†æˆåŠŸæƒ…å†µ
} catch (error) {
  // è§£æ„é”™è¯¯å¯¹è±¡
  const { message, code, details } = error as AgentError;
  this.handleError(message, code, details);
}
```

## æ€»ç»“

å¯¹è±¡è§£æ„èµ‹å€¼æ˜¯ç°ä»£ JavaScript/TypeScript å¼€å‘ä¸­çš„é‡è¦ç‰¹æ€§ï¼Œåœ¨ Gemini
CLI çš„ Agent ç³»ç»Ÿä¸­è¢«å¹¿æ³›åº”ç”¨ï¼š

### ğŸ¯ **æ ¸å¿ƒä¼˜åŠ¿**

1. **ä»£ç ç®€æ´**: å‡å°‘é‡å¤çš„å±æ€§è®¿é—®ä»£ç 
2. **ç±»å‹å®‰å…¨**: TypeScript èƒ½å¤Ÿå‡†ç¡®æ¨æ–­è§£æ„åå˜é‡çš„ç±»å‹
3. **æ„å›¾æ˜ç¡®**: æ¸…æ¥šè¡¨æ˜ä»£ç åªå…³å¿ƒå¯¹è±¡çš„ç‰¹å®šå±æ€§
4. **æ€§èƒ½ä¼˜åŒ–**: é¿å…é‡å¤çš„å¯¹è±¡å±æ€§æŸ¥æ‰¾

### ğŸ—ï¸ **åœ¨ Agent ç³»ç»Ÿä¸­çš„ä»·å€¼**

- **é…ç½®ç®¡ç†**: ä»å¤æ‚é…ç½®å¯¹è±¡ä¸­æå–éœ€è¦çš„éƒ¨åˆ†
- **å“åº”å¤„ç†**: ä» API å“åº”ä¸­æå–å…³é”®æ•°æ®
- **é”™è¯¯å¤„ç†**: å®‰å…¨åœ°æå–é”™è¯¯ä¿¡æ¯
- **ç±»å‹æ¨æ–­**: ä¿æŒå¼ºç±»å‹æ£€æŸ¥çš„åŒæ—¶ç®€åŒ–ä»£ç 

### ğŸš€ **æœ€ä½³å®è·µåŸåˆ™**

1. **æŒ‰éœ€æå–**: åªè§£æ„çœŸæ­£éœ€è¦çš„å±æ€§
2. **åˆç†å‘½å**: ä½¿ç”¨æ¸…æ™°çš„å˜é‡åæˆ–é‡å‘½å
3. **æä¾›é»˜è®¤å€¼**: ä¸ºå¯èƒ½ä¸å­˜åœ¨çš„å±æ€§è®¾ç½®åˆç†é»˜è®¤å€¼
4. **é¿å…è¿‡åº¦åµŒå¥—**: ä¿æŒè§£æ„ç»“æ„çš„å¯è¯»æ€§
5. **ç±»å‹å®‰å…¨**: ç»“åˆ TypeScript ç±»å‹ç³»ç»Ÿä½¿ç”¨

è¿™ç§è¯­æ³•ç‰¹æ€§è®© Gemini
CLI çš„ä»£ç æ›´åŠ ç°ä»£åŒ–ã€å¯è¯»æ€§æ›´å¼ºï¼Œæ˜¯æé«˜å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡çš„é‡è¦å·¥å…·ï¼
