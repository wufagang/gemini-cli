<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾ªç¯æ£€æµ‹ç®—æ³•æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4fc3f7;
            margin-bottom: 10px;
        }

        .demo-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
        }

        .input-section h3 {
            color: #81c784;
            margin-bottom: 15px;
        }

        #contentInput {
            width: 100%;
            height: 200px;
            background: #1e1e1e;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            padding: 10px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .controls {
            margin: 15px 0;
        }

        button {
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #29b6f6;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .status-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #1e1e1e;
            border-radius: 4px;
        }

        .status-label {
            color: #90caf9;
        }

        .status-value {
            font-weight: bold;
        }

        .status-true { color: #81c784; }
        .status-false { color: #e57373; }
        .status-normal { color: #fff3e0; }

        .visualization {
            grid-column: 1 / -1;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .viz-header {
            color: #ffb74d;
            margin-bottom: 20px;
            text-align: center;
        }

        .content-flow {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .content-chunk {
            background: #1e1e1e;
            border-radius: 6px;
            padding: 15px;
            border-left: 4px solid #4fc3f7;
            position: relative;
            animation: slideIn 0.5s ease-out;
        }

        .content-chunk.detected {
            border-left-color: #ff9800;
            background: #2d2416;
        }

        .content-chunk.reset {
            border-left-color: #f44336;
            background: #2d1616;
            animation: pulse 1s ease-in-out;
        }

        .content-chunk.loop-detected {
            border-left-color: #e91e63;
            background: #2d162a;
            animation: pulse 1s ease-in-out infinite;
        }

        .chunk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chunk-index {
            font-size: 12px;
            color: #90caf9;
            background: #1a237e;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .chunk-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .type-normal { background: #2e7d32; color: white; }
        .type-code { background: #ff6f00; color: white; }
        .type-table { background: #7b1fa2; color: white; }
        .type-list { background: #c62828; color: white; }
        .type-heading { background: #1565c0; color: white; }
        .type-blockquote { background: #5d4037; color: white; }
        .type-divider { background: #424242; color: white; }

        .chunk-content {
            font-size: 14px;
            white-space: pre-wrap;
            color: #e0e0e0;
        }

        .chunk-analysis {
            margin-top: 10px;
            font-size: 12px;
            color: #90caf9;
            border-top: 1px solid #555;
            padding-top: 8px;
        }

        .history-display {
            background: #1e1e1e;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-display h4 {
            color: #ffb74d;
            margin-bottom: 10px;
        }

        .history-content {
            font-size: 12px;
            color: #b0bec5;
            white-space: pre-wrap;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background: #1e1e1e;
            border-radius: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        .examples-section {
            margin-top: 20px;
        }

        .example-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .example-btn {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #388e3c;
            transform: translateY(-1px);
        }

        .processing {
            animation: processing 2s ease-in-out;
        }

        @keyframes processing {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #ff9800; }
            100% { transform: scale(1); }
        }

        .step-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e91e63;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ Gemini CLI å¾ªç¯æ£€æµ‹ç®—æ³•æ¼”ç¤º</h1>
            <p>å®æ—¶å¯è§†åŒ–å†…å®¹é‡å¤æ£€æµ‹çš„å·¥ä½œåŸç†</p>
        </div>

        <div class="demo-area">
            <div class="input-section">
                <h3>ğŸ“ è¾“å…¥å†…å®¹</h3>
                <textarea id="contentInput" placeholder="è¾“å…¥è¦æ£€æµ‹çš„å†…å®¹...

å°è¯•è¾“å…¥ä¸€äº›å†…å®¹ç±»å‹ï¼š
- æ™®é€šæ–‡æœ¬
- ```ä»£ç å—```
- | è¡¨æ ¼ | å†…å®¹ |
- * åˆ—è¡¨é¡¹
- # æ ‡é¢˜
- > å¼•ç”¨
- ========="></textarea>

                <div class="controls">
                    <button onclick="processContent()">ğŸ” æ£€æµ‹å†…å®¹</button>
                    <button onclick="clearDemo()">ğŸ—‘ï¸ æ¸…ç©ºæ¼”ç¤º</button>
                </div>

                <div class="examples-section">
                    <h4 style="color: #ffb74d; margin: 20px 0 10px 0;">ğŸ“š æµ‹è¯•æ¡ˆä¾‹</h4>
                    <div class="example-buttons">
                        <button onclick="runExample('normal')" class="example-btn">æ™®é€šæ–‡æœ¬</button>
                        <button onclick="runExample('codeblock')" class="example-btn">ä»£ç å—</button>
                        <button onclick="runExample('table')" class="example-btn">è¡¨æ ¼</button>
                        <button onclick="runExample('list')" class="example-btn">åˆ—è¡¨</button>
                        <button onclick="runExample('mixed')" class="example-btn">æ··åˆå†…å®¹</button>
                        <button onclick="runExample('loop')" class="example-btn">å¾ªç¯æ£€æµ‹</button>
                        <button onclick="runExample('complex')" class="example-btn">å¤æ‚åœºæ™¯</button>
                        <button onclick="runExample('realworld')" class="example-btn">çœŸå®æ¡ˆä¾‹</button>
                    </div>
                </div>
            </div>

            <div class="status-section">
                <h3>ğŸ“Š æ£€æµ‹çŠ¶æ€</h3>
                <div class="status-item">
                    <span class="status-label">ä»£ç å—çŠ¶æ€:</span>
                    <span id="codeBlockStatus" class="status-value status-false">å…³é—­</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å†å²é•¿åº¦:</span>
                    <span id="historyLength" class="status-value status-normal">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æ£€æµ‹åˆ°çš„ç±»å‹:</span>
                    <span id="detectedType" class="status-value status-normal">æ— </span>
                </div>
                <div class="status-item">
                    <span class="status-label">å¾ªç¯æ£€æµ‹:</span>
                    <span id="loopStatus" class="status-value status-false">æ— å¾ªç¯</span>
                </div>
                <div class="status-item">
                    <span class="status-label">è·Ÿè¸ªé‡ç½®:</span>
                    <span id="resetStatus" class="status-value status-false">æ­£å¸¸</span>
                </div>
            </div>
        </div>

        <div class="visualization">
            <h3 class="viz-header">ğŸ¬ å¤„ç†è¿‡ç¨‹å¯è§†åŒ–</h3>
            <div id="contentFlow" class="content-flow"></div>

            <div class="history-display">
                <h4>ğŸ“š å†…å®¹å†å²è®°å½•</h4>
                <div id="historyContent" class="history-content">ç©º</div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4fc3f7;"></div>
                    <span>æ™®é€šå†…å®¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>ç‰¹æ®Šå†…å®¹ç±»å‹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>è§¦å‘é‡ç½®</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e91e63;"></div>
                    <span>æ£€æµ‹åˆ°å¾ªç¯</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå¾ªç¯æ£€æµ‹æœåŠ¡çŠ¶æ€
        let streamContentHistory = '';
        let inCodeBlock = false;
        let chunkIndex = 0;
        let processedChunks = [];
        let currentStepIndex = 0;

        // æµ‹è¯•æ¡ˆä¾‹æ•°æ®
        const testExamples = {
            normal: {
                name: "æ™®é€šæ–‡æœ¬å¤„ç†",
                description: "æ¼”ç¤ºæ™®é€šæ–‡æœ¬å¦‚ä½•è¢«å¤„ç†å’Œç´¯ç§¯",
                steps: [
                    "ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œé˜³å…‰æ˜åªšã€‚",
                    "æˆ‘æ­£åœ¨å­¦ä¹ å¾ªç¯æ£€æµ‹ç®—æ³•ã€‚",
                    "è¿™ä¸ªç®—æ³•å¾ˆæœ‰è¶£ï¼Œèƒ½å¤Ÿè¯†åˆ«é‡å¤å†…å®¹ã€‚"
                ]
            },
            codeblock: {
                name: "ä»£ç å—å¤„ç†",
                description: "æ¼”ç¤ºä»£ç å—å¦‚ä½•è§¦å‘é‡ç½®æœºåˆ¶",
                steps: [
                    "è®©æˆ‘ä»¬å…ˆè¾“å…¥ä¸€äº›æ™®é€šæ–‡æœ¬ã€‚",
                    "```javascript\nfunction hello() {\n  console.log('Hello World');\n}\n```",
                    "ä»£ç å—ç»“æŸåï¼Œå†å²å·²è¢«é‡ç½®ã€‚",
                    "ç°åœ¨è¿™æ˜¯æ–°çš„æ™®é€šæ–‡æœ¬å†…å®¹ã€‚"
                ]
            },
            table: {
                name: "è¡¨æ ¼å†…å®¹å¤„ç†",
                description: "æ¼”ç¤ºè¡¨æ ¼å¦‚ä½•è§¦å‘é‡ç½®",
                steps: [
                    "è¿™æ˜¯è¡¨æ ¼å‰çš„æ–‡æœ¬å†…å®¹ã€‚",
                    "| å§“å | å¹´é¾„ | èŒä¸š |\n|------|------|------|\n| å¼ ä¸‰ | 25 | å·¥ç¨‹å¸ˆ |",
                    "è¡¨æ ¼å¤„ç†å®Œæˆï¼Œè¿½è¸ªå·²é‡ç½®ã€‚"
                ]
            },
            list: {
                name: "åˆ—è¡¨å†…å®¹å¤„ç†",
                description: "æ¼”ç¤ºå„ç§åˆ—è¡¨æ ¼å¼çš„å¤„ç†",
                steps: [
                    "å‡†å¤‡å±•ç¤ºåˆ—è¡¨å†…å®¹ï¼š",
                    "* ç¬¬ä¸€ä¸ªåˆ—è¡¨é¡¹\n* ç¬¬äºŒä¸ªåˆ—è¡¨é¡¹\n* ç¬¬ä¸‰ä¸ªåˆ—è¡¨é¡¹",
                    "ç°åœ¨æ˜¯æœ‰åºåˆ—è¡¨ï¼š",
                    "1. é¦–å…ˆåšè¿™ä¸ª\n2. ç„¶ååšé‚£ä¸ª\n3. æœ€åå®Œæˆ"
                ]
            },
            mixed: {
                name: "æ··åˆå†…å®¹å¤„ç†",
                description: "æ¼”ç¤ºå„ç§å†…å®¹ç±»å‹æ··åˆæ—¶çš„å¤„ç†",
                steps: [
                    "# è¿™æ˜¯ä¸€ä¸ªæ ‡é¢˜",
                    "æ™®é€šæ–‡æœ¬æ®µè½å†…å®¹ã€‚",
                    "> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—\n> åŒ…å«å¤šè¡Œå†…å®¹",
                    "```python\nprint('ä»£ç å—')\n```",
                    "===================",
                    "åˆ†éš”ç¬¦åçš„æ–°å†…å®¹ã€‚"
                ]
            },
            loop: {
                name: "å¾ªç¯æ£€æµ‹æ¼”ç¤º",
                description: "æ¼”ç¤ºå¦‚ä½•æ£€æµ‹é‡å¤å†…å®¹æ¨¡å¼",
                steps: [
                    "å¼€å§‹è¾“å…¥ä¸€äº›å†…å®¹ã€‚",
                    "é‡å¤å†…å®¹é‡å¤å†…å®¹é‡å¤å†…å®¹ã€‚",
                    "é‡å¤å†…å®¹é‡å¤å†…å®¹é‡å¤å†…å®¹é‡å¤å†…å®¹ã€‚",
                    "è¿™åº”è¯¥ä¼šè§¦å‘å¾ªç¯æ£€æµ‹ï¼"
                ]
            },
            complex: {
                name: "å¤æ‚åœºæ™¯å¤„ç†",
                description: "æ¼”ç¤ºå¤æ‚äº¤äº’åœºæ™¯çš„å¤„ç†é€»è¾‘",
                steps: [
                    "å¼€å§‹ä¸€ä¸ªå¤æ‚çš„å¯¹è¯åœºæ™¯ã€‚",
                    "```bash\nls -la\n```",
                    "å‘½ä»¤æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š",
                    "| æ–‡ä»¶å | å¤§å° | æƒé™ |\n|--------|------|------|",
                    "ç»§ç»­å¤„ç†å…¶ä»–å†…å®¹ã€‚",
                    "å†æ¬¡è¾“å…¥ç›¸åŒçš„å†…å®¹è¿›è¡Œæµ‹è¯•ã€‚",
                    "å†æ¬¡è¾“å…¥ç›¸åŒçš„å†…å®¹è¿›è¡Œæµ‹è¯•ã€‚",
                    "è¿™åº”è¯¥è§¦å‘å¾ªç¯æ£€æµ‹ã€‚"
                ]
            },
            realworld: {
                name: "çœŸå®ä¸–ç•Œæ¡ˆä¾‹",
                description: "æ¨¡æ‹ŸGemini CLIçš„çœŸå®ä½¿ç”¨åœºæ™¯",
                steps: [
                    "ç”¨æˆ·: è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªå‡½æ•°",
                    "```typescript\nfunction processData(input: string): boolean {\n  return input.length > 0;\n}\n```",
                    "AI: è¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œå®ƒæ£€æŸ¥è¾“å…¥å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºã€‚",
                    "ç”¨æˆ·: èƒ½ä¼˜åŒ–ä¸€ä¸‹å—ï¼Ÿ",
                    "```typescript\nfunction processData(input: string): boolean {\n  return Boolean(input?.trim());\n}\n```",
                    "AI: ä¼˜åŒ–åçš„ç‰ˆæœ¬æ›´å®‰å…¨ï¼Œå¤„ç†äº†ç©ºå€¼å’Œç©ºç™½å­—ç¬¦ã€‚"
                ]
            }
        };

        // å†…å®¹ç±»å‹æ£€æµ‹å‡½æ•°
        function detectContentType(content) {
            const numFences = (content.match(/```/g) ?? []).length;
            const hasTable = /(^|\n)\s*(\|.*\||[|+-]{3,})/.test(content);
            const hasListItem = /(^|\n)\s*[*-+]\s/.test(content) || /(^|\n)\s*\d+\.\s/.test(content);
            const hasHeading = /(^|\n)#+\s/.test(content);
            const hasBlockquote = /(^|\n)>\s/.test(content);
            const isDivider = /^[+-_=*\u2500-\u257F]+$/.test(content);

            if (numFences) return { type: 'code', name: 'ä»£ç å—', shouldReset: true };
            if (hasTable) return { type: 'table', name: 'è¡¨æ ¼', shouldReset: true };
            if (hasListItem) return { type: 'list', name: 'åˆ—è¡¨', shouldReset: true };
            if (hasHeading) return { type: 'heading', name: 'æ ‡é¢˜', shouldReset: true };
            if (hasBlockquote) return { type: 'blockquote', name: 'å¼•ç”¨', shouldReset: true };
            if (isDivider) return { type: 'divider', name: 'åˆ†éš”ç¬¦', shouldReset: true };

            return { type: 'normal', name: 'æ™®é€šæ–‡æœ¬', shouldReset: false };
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯
        function checkForLoop(content) {
            // æ›´ç²¾ç¡®çš„å¾ªç¯æ£€æµ‹é€»è¾‘
            const sentences = content.split(/[.!?ã€‚ï¼ï¼Ÿ]\s*/).filter(s => s.trim().length > 5);
            const sentenceCounts = {};

            for (const sentence of sentences) {
                const normalized = sentence.trim().toLowerCase();
                sentenceCounts[normalized] = (sentenceCounts[normalized] || 0) + 1;
            }

            // å¦‚æœæœ‰å¥å­é‡å¤è¶…è¿‡2æ¬¡ï¼Œè®¤ä¸ºæ˜¯å¾ªç¯
            const maxRepeats = Math.max(...Object.values(sentenceCounts));
            return maxRepeats >= 3;
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(detectedType, hasLoop, shouldReset) {
            document.getElementById('codeBlockStatus').textContent = inCodeBlock ? 'å¼€å¯' : 'å…³é—­';
            document.getElementById('codeBlockStatus').className = `status-value ${inCodeBlock ? 'status-true' : 'status-false'}`;

            document.getElementById('historyLength').textContent = streamContentHistory.length;

            document.getElementById('detectedType').textContent = detectedType.name;
            document.getElementById('detectedType').className = `status-value ${detectedType.shouldReset ? 'status-true' : 'status-normal'}`;

            document.getElementById('loopStatus').textContent = hasLoop ? 'æ£€æµ‹åˆ°å¾ªç¯' : 'æ— å¾ªç¯';
            document.getElementById('loopStatus').className = `status-value ${hasLoop ? 'status-true' : 'status-false'}`;

            document.getElementById('resetStatus').textContent = shouldReset ? 'å·²é‡ç½®' : 'æ­£å¸¸';
            document.getElementById('resetStatus').className = `status-value ${shouldReset ? 'status-true' : 'status-false'}`;
        }

        // æ·»åŠ å†…å®¹å—åˆ°å¯è§†åŒ–
        function addContentChunk(content, detectedType, hasLoop, shouldReset, stepNum = null) {
            const chunk = document.createElement('div');
            chunk.className = 'content-chunk processing';

            if (shouldReset) {
                chunk.classList.add('reset');
            } else if (hasLoop) {
                chunk.classList.add('loop-detected');
            } else if (detectedType.type !== 'normal') {
                chunk.classList.add('detected');
            }

            const analysis = [];
            if (detectedType.type !== 'normal') analysis.push(`æ£€æµ‹åˆ°: ${detectedType.name}`);
            if (shouldReset) analysis.push('ğŸ”„ è§¦å‘é‡ç½®');
            if (hasLoop) analysis.push('âš ï¸ å‘ç°å¾ªç¯æ¨¡å¼');
            if (inCodeBlock) analysis.push('ğŸ“ åœ¨ä»£ç å—å†…');

            const stepIndicator = stepNum ? `<div class="step-indicator">${stepNum}</div>` : '';

            chunk.innerHTML = `
                ${stepIndicator}
                <div class="chunk-header">
                    <span class="chunk-index">#${chunkIndex}</span>
                    <span class="chunk-type type-${detectedType.type}">${detectedType.name}</span>
                </div>
                <div class="chunk-content">${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                ${analysis.length > 0 ? `<div class="chunk-analysis">ğŸ“‹ ${analysis.join(' â€¢ ')}</div>` : ''}
            `;

            const flow = document.getElementById('contentFlow');
            flow.appendChild(chunk);

            // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
            setTimeout(() => {
                chunk.scrollIntoView({ behavior: 'smooth' });
                chunk.classList.remove('processing');
            }, 100);

            chunkIndex++;
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyElement = document.getElementById('historyContent');
            if (streamContentHistory) {
                const truncated = streamContentHistory.length > 500
                    ? streamContentHistory.substring(0, 500) + '\n...(æˆªæ–­)'
                    : streamContentHistory;
                historyElement.textContent = truncated;
            } else {
                historyElement.textContent = 'ç©º';
            }
        }

        // å¤„ç†å†…å®¹
        function processContent() {
            const input = document.getElementById('contentInput');
            const content = input.value.trim();

            if (!content) return;

            // æ£€æµ‹å†…å®¹ç±»å‹
            const detectedType = detectContentType(content);

            // æ›´æ–°ä»£ç å—çŠ¶æ€
            const numFences = (content.match(/```/g) ?? []).length;
            const wasInCodeBlock = inCodeBlock;
            if (numFences > 0) {
                inCodeBlock = numFences % 2 === 0 ? inCodeBlock : !inCodeBlock;
            }

            // å†³å®šæ˜¯å¦é‡ç½®
            const shouldReset = detectedType.shouldReset;
            if (shouldReset) {
                streamContentHistory = '';
                showResetAnimation();
            }

            // å¦‚æœåœ¨ä»£ç å—å†…æˆ–æ˜¯åˆ†éš”ç¬¦ï¼Œè·³è¿‡å¾ªç¯æ£€æµ‹
            const shouldSkipLoop = wasInCodeBlock || inCodeBlock || detectedType.type === 'divider';
            let hasLoop = false;

            if (!shouldSkipLoop) {
                streamContentHistory += content + ' ';
                hasLoop = checkForLoop(streamContentHistory);
            }

            // æ›´æ–°æ˜¾ç¤º
            updateStatus(detectedType, hasLoop, shouldReset);
            addContentChunk(content, detectedType, hasLoop, shouldReset);
            updateHistoryDisplay();

            // æ¸…ç©ºè¾“å…¥
            input.value = '';
        }

        // æ˜¾ç¤ºé‡ç½®åŠ¨ç”»
        function showResetAnimation() {
            const flow = document.getElementById('contentFlow');
            const resetIndicator = document.createElement('div');
            resetIndicator.className = 'content-chunk reset';
            resetIndicator.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #f44336; font-weight: bold;">
                    ğŸ”„ å†å²è®°å½•å·²é‡ç½®
                </div>
            `;
            flow.appendChild(resetIndicator);

            setTimeout(() => {
                resetIndicator.remove();
            }, 2000);
        }

        // è¿è¡Œç¤ºä¾‹
        async function runExample(exampleKey) {
            const example = testExamples[exampleKey];
            if (!example) return;

            // æ¸…ç©ºå½“å‰çŠ¶æ€
            clearDemo();

            // æ˜¾ç¤ºç¤ºä¾‹ä¿¡æ¯
            const flow = document.getElementById('contentFlow');
            const infoChunk = document.createElement('div');
            infoChunk.className = 'content-chunk';
            infoChunk.style.background = '#1a237e';
            infoChunk.innerHTML = `
                <div style="text-align: center; color: #fff;">
                    <h4>ğŸ¬ ${example.name}</h4>
                    <p style="font-size: 12px; margin-top: 8px; color: #90caf9;">${example.description}</p>
                </div>
            `;
            flow.appendChild(infoChunk);

            // é€æ­¥æ‰§è¡Œç¤ºä¾‹
            currentStepIndex = 0;
            for (let i = 0; i < example.steps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 1500));

                const step = example.steps[i];
                document.getElementById('contentInput').value = step;

                // é«˜äº®å½“å‰æ­¥éª¤
                document.getElementById('contentInput').classList.add('processing');
                await new Promise(resolve => setTimeout(resolve, 500));
                document.getElementById('contentInput').classList.remove('processing');

                processContentWithStep(i + 1);
            }
        }

        // å¸¦æ­¥éª¤ç¼–å·çš„å†…å®¹å¤„ç†
        function processContentWithStep(stepNum) {
            const input = document.getElementById('contentInput');
            const content = input.value.trim();

            if (!content) return;

            // æ£€æµ‹å†…å®¹ç±»å‹
            const detectedType = detectContentType(content);

            // æ›´æ–°ä»£ç å—çŠ¶æ€
            const numFences = (content.match(/```/g) ?? []).length;
            const wasInCodeBlock = inCodeBlock;
            if (numFences > 0) {
                inCodeBlock = numFences % 2 === 0 ? inCodeBlock : !inCodeBlock;
            }

            // å†³å®šæ˜¯å¦é‡ç½®
            const shouldReset = detectedType.shouldReset;
            if (shouldReset) {
                streamContentHistory = '';
            }

            // å¦‚æœåœ¨ä»£ç å—å†…æˆ–æ˜¯åˆ†éš”ç¬¦ï¼Œè·³è¿‡å¾ªç¯æ£€æµ‹
            const shouldSkipLoop = wasInCodeBlock || inCodeBlock || detectedType.type === 'divider';
            let hasLoop = false;

            if (!shouldSkipLoop) {
                streamContentHistory += content + ' ';
                hasLoop = checkForLoop(streamContentHistory);
            }

            // æ›´æ–°æ˜¾ç¤º
            updateStatus(detectedType, hasLoop, shouldReset);
            addContentChunk(content, detectedType, hasLoop, shouldReset, stepNum);
            updateHistoryDisplay();

            // æ¸…ç©ºè¾“å…¥
            input.value = '';
        }

        // æ¸…ç©ºæ¼”ç¤º
        function clearDemo() {
            streamContentHistory = '';
            inCodeBlock = false;
            chunkIndex = 0;
            processedChunks = [];
            currentStepIndex = 0;

            document.getElementById('contentInput').value = '';
            document.getElementById('contentFlow').innerHTML = '';

            updateStatus(
                { type: 'normal', name: 'æ— ', shouldReset: false },
                false,
                false
            );
            updateHistoryDisplay();
        }

        // å…è®¸Enteré”®è§¦å‘å¤„ç†
        document.getElementById('contentInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                processContent();
            }
        });

        // åˆå§‹åŒ–
        updateStatus(
            { type: 'normal', name: 'æ— ', shouldReset: false },
            false,
            false
        );
    </script>
</body>
</html>