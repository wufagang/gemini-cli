@startuml Gemini CLI å¤šAgentåä½œç³»ç»Ÿæ¶æ„å›¾
!theme aws-orange
!define MAIN_AGENT #1E40AF
!define SUBAGENT #7C3AED
!define A2A_SERVER #059669
!define MCP_AGENT #DC2626
!define TOOL_AGENT #EA580C
!define EXTERNAL #6B7280

title **Gemini CLI å¤šAgentåä½œç³»ç»Ÿæ¶æ„å›¾**\nåŸºäºAgenté©±åŠ¨çš„AIå·¥å…·å¹³å°

' ========================================
' ä¸»Agentå±‚ (Main Agent Layer)
' ========================================
package "ğŸ¤– **ä¸»Agentå±‚ (Primary Agent)**" as main_agent_layer MAIN_AGENT {

  component [**GeminiCLIä¸»Agent**\n(packages/cli)] as main_agent {
    portin user_input
    portout ai_response
    portout tool_calls
    portin tool_results
  }

  note top of main_agent
    **ä¸»AgentèŒè´£ï¼š**
    â€¢ ç”¨æˆ·äº¤äº’å’Œä¼šè¯ç®¡ç†
    â€¢ AIå¯¹è¯æµç¨‹æ§åˆ¶
    â€¢ Subagentä»»åŠ¡è°ƒåº¦
    â€¢ å·¥å…·è°ƒç”¨åè°ƒ
    â€¢ ç»ˆç«¯UIæ¸²æŸ“ (React+Ink)

    **æ ¸å¿ƒèƒ½åŠ›ï¼š**
    â€¢ æµå¼AIå¯¹è¯å¤„ç†
    â€¢ å®æ—¶å†…å®¹æ¸²æŸ“
    â€¢ å¤šAgentä»»åŠ¡ç¼–æ’
    â€¢ ç”¨æˆ·ç¡®è®¤æœºåˆ¶
  end note

  package "Agentæ ¸å¿ƒç»„ä»¶" as agent_core {
    [GeminiClient\nAIå¯¹è¯å¼•æ“] as gemini_client
    [AgentExecutor\nAgentæ‰§è¡Œå™¨] as agent_executor
    [TaskManager\nä»»åŠ¡ç®¡ç†å™¨] as task_manager
    [ToolOrchestrator\nå·¥å…·ç¼–æ’å™¨] as tool_orchestrator
  }
}

' ========================================
' A2A Server (Agent-to-Agenté€šä¿¡ä¸­å¿ƒ)
' ========================================
package "ğŸ”— **A2A Server (Agenté—´é€šä¿¡ä¸­å¿ƒ)**" as a2a_server_layer A2A_SERVER {

  component [**A2A Server**\n(packages/a2a-server)] as a2a_server {
    portin agent_requests
    portout agent_responses
    portin task_submissions
    portout task_results
  }

  note top of a2a_server
    **A2A ServerèŒè´£ï¼š**
    â€¢ Agenté—´é€šä¿¡åè°ƒ
    â€¢ ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
    â€¢ çŠ¶æ€åŒæ­¥å’Œäº‹ä»¶åˆ†å‘
    â€¢ å¤šAgentä¼šè¯ç®¡ç†

    **æ ¸å¿ƒç»„ä»¶ï¼š**
    â€¢ CoderAgentExecutor
    â€¢ TaskWrapper
    â€¢ ExecutionEventBus
    â€¢ HTTP API Server
  end note

  package "A2Aæ ¸å¿ƒæœåŠ¡" as a2a_core {
    [CoderAgentExecutor\nAgentæ‰§è¡Œå™¨] as coder_executor
    [TaskWrapper\nä»»åŠ¡åŒ…è£…å™¨] as task_wrapper
    [ExecutionEventBus\näº‹ä»¶æ€»çº¿] as event_bus
    [AgentStateManager\nçŠ¶æ€ç®¡ç†å™¨] as state_manager
  }

  package "é€šä¿¡åè®®å±‚" as communication_layer {
    [HTTP API Server\nRESTæ¥å£] as http_api
    [WebSocket Handler\nå®æ—¶é€šä¿¡] as websocket_handler
    [Message Queue\næ¶ˆæ¯é˜Ÿåˆ—] as message_queue
  }
}

' ========================================
' Subagentå±‚ (å­Agentç³»ç»Ÿ)
' ========================================
package "ğŸ¯ **Subagentå±‚ (ä¸“ç”¨Agentç³»ç»Ÿ)**" as subagent_layer SUBAGENT {

  note top of subagent_layer
    **Subagentç³»ç»Ÿç‰¹ç‚¹ï¼š**
    â€¢ ä¸“é—¨åŒ–ä»»åŠ¡å¤„ç†
    â€¢ å¯ä½œä¸ºå·¥å…·è¢«è°ƒç”¨
    â€¢ ç‹¬ç«‹çš„AIæ¨¡å‹é…ç½®
    â€¢ æ ‡å‡†åŒ–è¾“å…¥/è¾“å‡ºæ¥å£
  end note

  package "Subagentå®ä¾‹" as subagent_instances {
    component [**CodeAnalyzer Agent**\nä»£ç åˆ†æä¸“å®¶] as code_analyzer_agent {
      note bottom: ä¸“é—¨å¤„ç†ä»£ç åˆ†æã€é‡æ„ã€å®¡æŸ¥ä»»åŠ¡
    }

    component [**FileManager Agent**\næ–‡ä»¶ç®¡ç†ä¸“å®¶] as file_manager_agent {
      note bottom: ä¸“é—¨å¤„ç†æ–‡ä»¶æ“ä½œã€ç›®å½•ç®¡ç†ä»»åŠ¡
    }

    component [**DevOps Agent**\nè¿ç»´ä¸“å®¶] as devops_agent {
      note bottom: ä¸“é—¨å¤„ç†éƒ¨ç½²ã€ç›‘æ§ã€CI/CDä»»åŠ¡
    }

    component [**Research Agent**\nç ”ç©¶åŠ©æ‰‹] as research_agent {
      note bottom: ä¸“é—¨å¤„ç†ä¿¡æ¯æœç´¢ã€æ–‡æ¡£ç”Ÿæˆä»»åŠ¡
    }
  }

  package "SubagentåŸºç¡€è®¾æ–½" as subagent_infra {
    [SubagentToolWrapper\nå·¥å…·åŒ…è£…å™¨] as subagent_wrapper
    [AgentDefinition\nAgentå®šä¹‰ç³»ç»Ÿ] as agent_definition
    [AgentRegistry\nAgentæ³¨å†Œè¡¨] as agent_registry
  }
}

' ========================================
' MCP Agentç”Ÿæ€ (ç¬¬ä¸‰æ–¹Agent)
' ========================================
package "ğŸŒ **MCP Agentç”Ÿæ€ (ç¬¬ä¸‰æ–¹Agent)**" as mcp_agent_layer MCP_AGENT {

  note top of mcp_agent_layer
    **MCP Agentç”Ÿæ€ï¼š**
    â€¢ åŸºäºMCPåè®®çš„æ ‡å‡†åŒ–Agent
    â€¢ ç¤¾åŒºé©±åŠ¨çš„å·¥å…·æä¾›è€…
    â€¢ å¯æ’æ‹”çš„èƒ½åŠ›æ‰©å±•
    â€¢ è·¨è¯­è¨€è·¨å¹³å°æ”¯æŒ
  end note

  package "MCP Agentå®ä¾‹" as mcp_agents {
    component [**Database Agent**\næ•°æ®åº“æ“ä½œ] as db_agent {
      note bottom: æä¾›SQLæŸ¥è¯¢ã€æ•°æ®åˆ†æå·¥å…·
    }

    component [**API Testing Agent**\nAPIæµ‹è¯•] as api_test_agent {
      note bottom: æä¾›APIæµ‹è¯•ã€ç›‘æ§å·¥å…·
    }

    component [**Cloud Services Agent**\näº‘æœåŠ¡ç®¡ç†] as cloud_agent {
      note bottom: æä¾›AWS/GCP/Azureæ“ä½œå·¥å…·
    }

    component [**Slack Agent**\nå›¢é˜Ÿåä½œ] as slack_agent {
      note bottom: æä¾›Slackæ¶ˆæ¯ã€é€šçŸ¥å·¥å…·
    }
  }

  package "MCPåŸºç¡€è®¾æ–½" as mcp_infra {
    [McpClientManager\nMCPå®¢æˆ·ç«¯ç®¡ç†] as mcp_client_manager
    [MCPProxyTool\nMCPä»£ç†å·¥å…·] as mcp_proxy
    [ToolDiscovery\nå·¥å…·å‘ç°å¼•æ“] as tool_discovery
  }
}

' ========================================
' å·¥å…·Agentå±‚ (å†…ç½®å·¥å…·Agent)
' ========================================
package "ğŸ”§ **å·¥å…·Agentå±‚ (å†…ç½®å·¥å…·)**" as tool_agent_layer TOOL_AGENT {

  note top of tool_agent_layer
    **å†…ç½®å·¥å…·Agentï¼š**
    â€¢ é«˜åº¦ä¼˜åŒ–çš„æ ¸å¿ƒå·¥å…·
    â€¢ ç›´æ¥é›†æˆæ— éœ€åè®®å¼€é”€
    â€¢ å®‰å…¨æ²™ç®±æ‰§è¡Œç¯å¢ƒ
    â€¢ ä¸°å¯Œçš„æ–‡ä»¶å’Œç³»ç»Ÿæ“ä½œ
  end note

  package "ç³»ç»Ÿå·¥å…·Agent" as system_tools {
    [ShellAgent\nShellæ‰§è¡Œä¸“å®¶] as shell_agent
    [FileAgent\næ–‡ä»¶æ“ä½œä¸“å®¶] as file_agent
    [GitAgent\nGitæ“ä½œä¸“å®¶] as git_agent
    [SearchAgent\næœç´¢ä¸“å®¶] as search_agent
  }

  package "ç½‘ç»œå·¥å…·Agent" as network_tools {
    [WebAgent\nç½‘ç»œè¯·æ±‚ä¸“å®¶] as web_agent
    [APIAgent\nAPIè°ƒç”¨ä¸“å®¶] as api_agent
    [DownloadAgent\nä¸‹è½½ä¸“å®¶] as download_agent
  }

  package "å¼€å‘å·¥å…·Agent" as dev_tools {
    [CodeAgent\nä»£ç æ“ä½œä¸“å®¶] as code_agent
    [TestAgent\næµ‹è¯•æ‰§è¡Œä¸“å®¶] as test_agent
    [BuildAgent\næ„å»ºä¸“å®¶] as build_agent
  }
}

' ========================================
' å¤–éƒ¨æœåŠ¡å±‚ (External Services)
' ========================================
cloud "ğŸŒ **å¤–éƒ¨æœåŠ¡å±‚**" as external_services EXTERNAL {

  package "Google AIç”Ÿæ€" as google_ai {
    [Gemini API\nAIæ¨¡å‹æœåŠ¡] as gemini_api
    [Vertex AI\nä¼ä¸šAIå¹³å°] as vertex_ai
    [Google Search\næœç´¢grounding] as google_search
  }

  package "å¼€å‘ç”Ÿæ€" as dev_ecosystem {
    [GitHub\nä»£ç ä»“åº“] as github
    [VS Code\né›†æˆå¼€å‘ç¯å¢ƒ] as vscode
    [Docker\nå®¹å™¨è¿è¡Œæ—¶] as docker
  }

  package "ä¼ä¸šæœåŠ¡" as enterprise_services {
    [Slack\nå›¢é˜Ÿåä½œ] as slack
    [Jira\né¡¹ç›®ç®¡ç†] as jira
    [AWS/GCP/Azure\näº‘æœåŠ¡] as cloud_services
  }
}

' ========================================
' æ•°æ®å’ŒçŠ¶æ€å±‚
' ========================================
database "ğŸ’¾ **AgentçŠ¶æ€å’Œæ•°æ®å±‚**" as data_layer {
  [Agenté…ç½®å­˜å‚¨\nå„Agentçš„é…ç½®å’Œç­–ç•¥] as agent_configs
  [ä»»åŠ¡çŠ¶æ€å­˜å‚¨\nå¤šAgentä»»åŠ¡çŠ¶æ€è·Ÿè¸ª] as task_states
  [ä¼šè¯å†å²å­˜å‚¨\nAgenté—´å¯¹è¯å†å²] as conversation_history
  [å·¥å…·ç¼“å­˜å­˜å‚¨\nå·¥å…·è°ƒç”¨ç»“æœç¼“å­˜] as tool_cache
  [æƒé™é…ç½®å­˜å‚¨\nAgentæƒé™å’Œå®‰å…¨ç­–ç•¥] as permission_configs
}

' ========================================
' Agenté—´é€šä¿¡æµ (æ ¸å¿ƒæ•°æ®æµ)
' ========================================

' ç”¨æˆ·åˆ°ä¸»Agent
user_input --> main_agent : "ç”¨æˆ·æŒ‡ä»¤"
main_agent --> ai_response : "AIå“åº”"

' ä¸»Agentåˆ°A2A Server
main_agent -down-> a2a_server : "**Agentä»»åŠ¡å§”æ´¾**"
a2a_server -up-> main_agent : "ä»»åŠ¡æ‰§è¡Œç»“æœ"
tool_orchestrator -down-> coder_executor : "ä»»åŠ¡æäº¤"
task_manager -down-> task_wrapper : "ä»»åŠ¡ç®¡ç†"

' A2A Serveråˆ°Subagent
a2a_server -down-> subagent_layer : "**Subagentè°ƒç”¨**"
coder_executor -down-> code_analyzer_agent : "ä»£ç åˆ†æä»»åŠ¡"
coder_executor -down-> file_manager_agent : "æ–‡ä»¶ç®¡ç†ä»»åŠ¡"
event_bus -down-> subagent_infra : "çŠ¶æ€åŒæ­¥"

' ä¸»Agentåˆ°MCP Agent
main_agent -right-> mcp_agent_layer : "**MCPå·¥å…·è°ƒç”¨**"
tool_orchestrator -right-> mcp_client_manager : "MCPå·¥å…·å‘ç°"
mcp_proxy -right-> db_agent : "æ•°æ®åº“æ“ä½œ"
mcp_proxy -right-> api_test_agent : "APIæµ‹è¯•"

' ä¸»Agentåˆ°å·¥å…·Agent
main_agent -down-> tool_agent_layer : "**å†…ç½®å·¥å…·è°ƒç”¨**"
tool_orchestrator -down-> shell_agent : "Shellæ‰§è¡Œ"
tool_orchestrator -down-> file_agent : "æ–‡ä»¶æ“ä½œ"
tool_orchestrator -down-> web_agent : "ç½‘ç»œè¯·æ±‚"

' æ‰€æœ‰Agentåˆ°å¤–éƒ¨æœåŠ¡
main_agent -right-> gemini_api : "AI APIè°ƒç”¨"
subagent_layer -right-> external_services : "å¤–éƒ¨æœåŠ¡é›†æˆ"
mcp_agent_layer -right-> external_services : "ç¬¬ä¸‰æ–¹æœåŠ¡"
tool_agent_layer -right-> external_services : "ç³»ç»Ÿèµ„æºè®¿é—®"

' æ•°æ®å±‚è¿æ¥
main_agent -down-> data_layer : "çŠ¶æ€æŒä¹…åŒ–"
a2a_server -down-> data_layer : "ä»»åŠ¡çŠ¶æ€ç®¡ç†"
subagent_layer -down-> data_layer : "Agenté…ç½®"
mcp_agent_layer -down-> data_layer : "å·¥å…·ç¼“å­˜"

' ========================================
' å…³é”®ç‰¹æ€§æ ‡æ³¨
' ========================================

note left of main_agent
  **ğŸš€ Agentåä½œä¼˜åŠ¿**
  â€¢ ä»»åŠ¡ä¸“ä¸šåŒ–åˆ†å·¥
  â€¢ å¹¶è¡Œå¤„ç†èƒ½åŠ›
  â€¢ æ¨¡å—åŒ–å¯æ‰©å±•
  â€¢ æ•…éšœéš”ç¦»æœºåˆ¶
  â€¢ è´Ÿè½½å‡è¡¡åˆ†å‘
end note

note right of a2a_server
  **âš¡ é€šä¿¡ä¸­å¿ƒç‰¹æ€§**
  â€¢ æ ‡å‡†åŒ–Agentåè®®
  â€¢ ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
  â€¢ å®æ—¶çŠ¶æ€åŒæ­¥
  â€¢ æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶
  â€¢ é”™è¯¯æ¢å¤æœºåˆ¶
end note

note bottom of mcp_agent_layer
  **ğŸ”Œ MCPç”Ÿæ€ä»·å€¼**
  â€¢ ç¤¾åŒºé©±åŠ¨æ‰©å±•
  â€¢ è·¨è¯­è¨€å…¼å®¹
  â€¢ æ ‡å‡†åŒ–æ¥å£
  â€¢ çƒ­æ’æ‹”èƒ½åŠ›
  â€¢ ä¸°å¯Œå·¥å…·åº“
end note

' ========================================
' Agentæ‰§è¡Œæµç¨‹æ ‡æ³¨
' ========================================

note top of main_agent_layer
  **ğŸ¯ å¤šAgentæ‰§è¡Œæµç¨‹**
  1. ç”¨æˆ·è¾“å…¥ â†’ ä¸»Agentåˆ†æ
  2. ä»»åŠ¡åˆ†è§£ â†’ é€‰æ‹©åˆé€‚çš„Agent
  3. é€šè¿‡A2A Serverå§”æ´¾ä»»åŠ¡
  4. Subagent/MCP Agentæ‰§è¡Œ
  5. ç»“æœèšåˆ â†’ ç”¨æˆ·å±•ç¤º
end note

@enduml